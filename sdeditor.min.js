var _;function QedEditor(d,c,b,a){this.extraparams={};if(typeof(a)!="undefined"){this.extraparams=a}this.name=d;this.context=b;this.element=jQuery('<div class="qededitor qedcontext'+this.context+'"></div>');jQuery(c).append(this.element);this.element[0].editor=this;this.plugins=[];this.derivation=new SdDerivation(this.context,this);this.open(this.name);this.undoStack=new Eventstack(0);this.redoStack=new Eventstack(0);this.nextFocus="";this.installPlugins();this.init()}QedEditor.inited=false;QedEditor.options={lang:"en"};QedEditor.locales={task:{en:"task",fi:"tehtävä",sv:"uppgift",et:"ülesanne"},taskass:{en:"assumption",fi:"oletus",sv:"antagande",et:"eeldus"},assumption:{en:"assumption",fi:"oletus",sv:"antagande",et:"eeldus"},taskobs:{en:"observation",fi:"havainto",sv:"observation",et:"tähelepanek"},observation:{en:"observation",fi:"havainto",sv:"observation",et:"tähelepanek"},term:{en:"term",fi:"termi",sv:"term",et:"avaldis"},relation:{en:"relation",fi:"relaatio",sv:"relation",et:"seos"},motivation:{en:"motivation",fi:"perustelu",sv:"motivering",et:"selgitus"},step:{en:"step",fi:"askel",sv:"steg",et:"samm"},subderivation:{en:"subderivation",fi:"alipäättely",sv:"delhärledning",et:"alalahendus"},derivation:{en:"derivation",fi:"päättelyketju",sv:"härledning",et:"lahendus"},derivationmotivation:{en:"derivationmotivation",fi:"päättelyketjun perustelu",sv:"motivering av härledningen",et:"lahenduse selgitus"},Undo:{en:"undo",fi:"kumoa",sv:"ångra",et:"tühista käsk"},Redo:{en:"redo",fi:"tee uudelleen",sv:"återställ",et:"taasta käsk"},relations:{en:"relations",fi:"relaatiot",sv:"relationer",et:"seosed"},misc:{en:"misc",fi:"sekalaista",sv:"övrigt",et:"mitmesugust"},greeks:{en:"greeks",fi:"kreikkalaiset",sv:"grekiska",et:"kreeka"}};QedEditor.options.TiddlyWiki={saveTiddler:"QedDerivationsData",recycleTiddler:"QedDerivationsRecycleBin"};_=QedEditor.prototype;_.init=function(){if(typeof(QedEditor.inited)=="undefined"||!QedEditor.inited){jQuery(document).keyup(function(f){if(f.keyCode=="13"&&(f.ctrlKey||f.altKey)){if(f.shiftKey){var d=jQuery(".qededitor.qedediting");if(typeof(QedEditor.buttonpanel.lastfocus)!="undefined"){var c=(QedEditor.buttonpanel.lastfocus).parents(".qededitor");var b=d.index(c);var a=d.eq((b+1)%d.length).find(".mathquill-editable").last();a.focus()}else{var a=jQuery(".qededitor .mathquill-editable").eq(0);a.focus()}}else{if(typeof(QedEditor.buttonpanel.lastfocus)!="undefined"){var a=jQuery(QedEditor.buttonpanel.lastfocus);a.focus()}else{var a=jQuery(".qededitor .mathquill-editable");a.focus()}}testilogit.focuselem=a;a.parents(".qededitor")[0].editor.scrollInView(a)}});QedEditor.inited=true}if(this.context=="moodlesa"&&(jQuery(this.element).parent().hasClass("qedsaveajax")||jQuery(this.element).parent().hasClass("qedajaxsave"))){this.derivation.saveajax=true}else{this.derivation.saveajax=false}};_.show=function(){var a=this.derivation.html("show");jQuery(this.element).empty().append(a);this.element.find(".mathquill-editable").mathquill("editable");this.element.find(".mathquill-textbox").mathquill("textbox");this.element.find(".mathquill-embedded-latex").mathquill();this.element.find("a.command_qededit").click(function(){jQuery(this).parents(".qededitor")[0].editor.edit();return false});this.element.find("td.ldots").click(function(){var d=jQuery(this).next().attr("loc");var h=d.split("_");var j=h[h.length-2];if(j=="observation"){h.push("motivation")}else{if(j=="term"){h[h.length-2]="motivation";h[h.length-1]=parseInt(h[h.length-1])-1}}var k=h.join("_");var l=jQuery(this).parents(".qededitor")[0].editor;var e=l.derivation;var b=e.findLocation(k);b.switchHideSubders();l.save();var c=k+"_subderivation_";var g=jQuery(this).parent().siblings().children('td[loc*="'+c+'"]');var m=g.parent();for(var f=0;f<m.length;f++){if(m.eq(f).hasClass("sdhidden")){g.eq(f).children("div.sdsubderivation").hide();m.eq(f).removeClass("sdhidden");g.eq(f).children("div.sdsubderivation").slideDown("slow");g.eq(f).find(".mathquill-rendered-math").mathquill("redraw")}else{g.eq(f).children("div.sdsubderivation").slideUp("slow",function(){jQuery(this).parents("tr").eq(0).addClass("sdhidden");jQuery(this).children("div.subderivation").show()})}}})};_.edit=function(){if(jQuery("#mathbuttonpanel").length==0){jQuery("#mathbuttonwrapper").append(QedEditor.buttonpanel.html(""));QedEditor.buttonpanel.initClicks()}var b="";var c='<div class="structuredderivation" sdname="'+this.name+'">\n';c+='<div class="qededitorbuttons">\n';c+='<a href="javascript:;" class="button command_qedclose command_editorclose" title="Close"></a>\n';b=this.undoStack.isempty()?"":" active";c+='<a href="javascript:;" class="button command_qedundo command_editorundo'+b+'" title="Undo"><span>&#x21b6;</span></a>\n';b=this.redoStack.isempty()?"":" active";c+='<a href="javascript:;" class="button command_qedredo command_editorredo'+b+'" title="Redo"><span>&#x21b7;</span></a>\n';c+=this.pluginButtons();c+="</div>\n";c+=this.derivation.html("edit",this.name);c+="\n</div>";var a=jQuery(this.element);a.empty().append(c);a.find("div.structuredderivation").addClass("sdediting");a.addClass("qedediting");this.element.find(".mathquill-editable").mathquill("editable");this.element.find(".mathquill-textbox").mathquill("textbox");this.element.find(".mathquill-embedded-latex").mathquill();this.element.find("td.ldots").click(function(){var f=jQuery(this).next().attr("loc");var k=f.split("_");var l=k[k.length-2];if(l=="observation"){k.push("motivation")}else{if(l=="term"){k[k.length-2]="motivation";k[k.length-1]=parseInt(k[k.length-1])-1}}var m=k.join("_");var n=jQuery(this).parents(".qededitor")[0].editor;var g=n.derivation;var d=g.findLocation(m);d.switchHideSubders();n.save();var e=m+"_subderivation_";var j=jQuery(this).parent().siblings().children('td[loc*="'+e+'"]');var o=j.parent();for(var h=0;h<o.length;h++){if(o.eq(h).hasClass("sdhidden")){j.eq(h).children("div.sdsubderivation").hide();o.eq(h).removeClass("sdhidden");j.eq(h).children("div.sdsubderivation").slideDown("slow");j.eq(h).find(".mathquill-rendered-math").mathquill("redraw")}else{j.eq(h).children("div.sdsubderivation").slideUp("slow",function(){jQuery(this).parents("tr").eq(0).addClass("sdhidden");jQuery(this).children("div.subderivation").show()})}}});a.find("a.command_qedclose").click(function(){var d=jQuery(this).parents("div.structuredderivation");d.removeClass("sdediting");d.parents(".qededitor").eq(0).removeClass("qedediting");$editor=d.parents("div.qededitor");$editor[0].editor.save();$editor[0].editor.show();if(jQuery(".sdediting").length==0){jQuery("#mathbuttonpanel").remove()}return false});a.find("a.command_qedundo").click(function(){jQuery(this).parents("div.qededitor")[0].editor.undo();return false});a.find("a.command_qedredo.active").click(function(){jQuery(this).parents("div.qededitor")[0].editor.redo();return false});a.find("a.command_qedredo").not(".active").click(function(){return false});a.find(".mathquill-editable").focusout(function(k){$mqbox=jQuery(this);var f=$mqbox.parents("div.qededitor");var m=$mqbox.parents("td").attr("loc");var n=$mqbox.parents("td").attr("class");var g=f[0].editor.derivation;var j=g.findLocation(m);QedEditor.buttonpanel.lastfocus=$mqbox;$mqbox.parents("tr:eq(0)").removeClass("sdeditfocuson");var d=$mqbox.mathquill("latex").replace(/</g,"\\lt ").replace(/>/g,"\\gt ");var l=g.findLocation(m).text;if(l!=d){if(typeof(j.virgin)!="undefined"&&j.virgin){$mqbox.parents("td.virgin").removeClass("virgin")}$mqbox.parents(".qededitor").eq(0).find("a.command_qedundo").addClass("active");$mqbox.parents(".qededitor").eq(0).find("a.command_qedredo").removeClass("active");var h=[d,l];var i=new EditorEvent("edit",n,m,"",h);f[0].editor.doEvent(i)}}).click(function(){jQuery(this).parents("tr:eq(0)").addClass("sdeditfocuson")}).focus(function(){jQuery(this).parents("tr:eq(0)").addClass("sdeditfocuson")});a.find(".mathquill-editable").keyup(function(n){var m=jQuery(this).parents(".qededitor")[0].editor;if(n.keyCode=="13"&&!(n.ctrlKey||n.altKey)){jQuery(n.currentTarget).focusout().blur()}else{if(n.keyCode=="38"&&(n.ctrlKey||n.altKey)){var g=jQuery(n.currentTarget).parents(".qededitor").eq(0).find(".mathquill-editable:visible");var k=g.index(jQuery(n.currentTarget));if(k>0){jQuery(n.currentTarget).focusout().blur();g.eq(k-1).focus();m.scrollInView(g.eq(k-1))}}else{if(n.keyCode=="40"&&(n.ctrlKey||n.altKey)){var g=jQuery(n.currentTarget).parents(".qededitor").eq(0).find(".mathquill-editable:visible");var k=g.index(jQuery(n.currentTarget));if(k<g.length-1){jQuery(n.currentTarget).focusout().blur();g.eq(k+1).focus();m.scrollInView(g.eq(k+1))}}else{if(n.keyCode=="13"&&(n.ctrlKey||n.altKey)){var j=jQuery(this).parents("td").eq(0);var o=j.parents("tr").eq(0);jQuery("#qededitormenuwrapper").remove();o.find("td").eq(1).append('<div id="qededitormenuwrapper"></div>');var l=o.find("#qededitormenuwrapper");var f={minus:[],plus:[],undo:!m.undoStack.isempty(),redo:!m.redoStack.isempty()};var i=o.find(".sdbeforebuttons .minusbuttons");if(i.attr("menuitems")){f.minus=i.attr("menuitems").split(" ")}var h=o.find(".sdafterbuttons .plusbuttons");if(h.attr("menuitems")){f.plus=h.attr("menuitems").split(" ")}var d=new QedEditorMenu(f);l.append(d.html());d.menuInit();n.stopPropagation();n.preventDefault()}else{}}}}});a.find(".sdbeforebuttons").click(function(j){var g=jQuery(this).parents(".qededitor")[0].editor;var f=jQuery(this).parents("td").eq(0);jQuery("#qededitormenuwrapper").remove();jQuery(this).append('<div id="qededitormenuwrapper" class="minus"></div>');var d=f.find("#qededitormenuwrapper");var k={minus:[],plus:[],undo:false,redo:false};var i=f.find(".minusbuttons");if(i.attr("menuitems")){k.minus=i.attr("menuitems").split(" ")}var h=new QedEditorMenu(k);d.append(h.html());h.menuInit()});a.find(".sdafterbuttons").click(function(j){var h=jQuery(this).parents(".qededitor")[0].editor;var g=jQuery(this).parents("td").eq(0);jQuery("#qededitormenuwrapper").remove();jQuery(this).append('<div id="qededitormenuwrapper" class="plus"></div>');var d=g.find("#qededitormenuwrapper");var k={minus:[],plus:[],undo:false,redo:false};var f=g.find(".plusbuttons");if(f.attr("menuitems")){k.plus=f.attr("menuitems").split(" ")}var i=new QedEditorMenu(k);d.append(i.html());i.menuInit()});this.initPlugins();this.setFocus()};_.doEvent=function(c){if(c.event!="undo"&&c.event!="redo"){var a=this.derivation.eventDo(c);if(c.event=="remove"&&c.item=="subderivation"){for(var b=0;b<a.length;b++){this.deleteDeriv(a[b],true)}}this.redoStack.clear();this.undoStack.push(c.invert())}else{if(c.event=="undo"){this.undo()}else{if(c.event=="redo"){this.redo()}}}this.save();if(c.event!="edit"&&c.event!="undo"&&c.event!="redo"){this.edit()}};_.undo=function(){var f=this.undoStack.pop();if(typeof(f)!="undefined"){if(f.event=="add"&&f.item=="subderivation"){var e=this.getDerNames(f.newData());for(var b=0;b<e.length;b++){this.recycleCancel(e[b])}var d=this.getDerivs(this.derivation.name);var a=new SdSubDeriv(f.newData(),this.context,this.editor,d);var c=new EditorEvent(f.event,f.item,f.location,f.position,[a,""]);this.derivation.eventDo(c)}else{this.derivation.eventDo(f)}this.redoStack.push(f.invert());this.save();this.edit()}};_.redo=function(){var a=this.redoStack.pop();if(typeof(a)!="undefined"){this.derivation.eventDo(a);this.undoStack.push(a.invert());this.save();this.edit()}};_.setFocus=function(a){if(typeof(a)=="undefined"){a=this.nextFocus}if(a==""){a=jQuery(this.element).find(".mathquill-editable").eq(0).parents("td").attr("loc")}var b=jQuery(this.element).find("td[loc="+a+"] .mathquill-editable");if(b.length>0){b.focus()}else{var c=jQuery(this.element).find("td.term");a=c.eq(c.length-1).attr("loc");this.setFocus(a)}};_.scrollInView=function(d){switch(this.context){case"moodlesa":var c=jQuery(window);var b=jQuery("html");var e=0;var a=b.scrollTop();break;case"tiddlywiki":var c=jQuery("#displayArea");var b=c;var e=b.scrollTop()-b.offset().top;var a=b.offset().top;break;default:var c=jQuery(window);var b=jQuery("html")}if(jQuery(d).offset().top-a>c.height()-120){b.stop();b.animate({scrollTop:jQuery(d).offset().top+e+150-c.height()},300)}if(jQuery(d).offset().top-a<120){b.stop();b.animate({scrollTop:jQuery(d).offset().top+e-150},300)}};_.derivationExists=function(c){if(typeof(g)=="undefined"){var g={}}switch(this.context){case"tiddlywiki":var i;var e=QedEditor.options.TiddlyWiki.saveTiddler;if(typeof(this.extraparams.tiddler)!="undefined"){e=this.extraparams.tiddler}i=(typeof(DataTiddler.getData(e,"derivations",{})[c])!="undefined");return i;break;case"moodlesa":var b=this.name;var a=jQuery("#"+b+' .ablock input[type="text"]');var d=a.val();var h="{}";try{h=JSON.parse(d)}catch(f){h={derivations:{},recycled:{}}}if(typeof(h.derivations)=="undefined"){h.derivations={}}return(typeof(h.derivations[c])!="undefined");break;case"moodledesc":var b=this.name;var a=jQuery("#"+b+" .qtext .data");var d=a.html();var h="{}";try{h=JSON.parse(d)}catch(f){h={derivations:{},recycled:{}}}if(typeof(h.derivations)=="undefined"){h.derivations={}}return(typeof(h.derivations[c])!="undefined");default:return false}};_.getDerivsWithPrefix=function(g){if(typeof(h)=="undefined"){var h={}}switch(this.context){case"tiddlywiki":var k=[];var e=QedEditor.options.TiddlyWiki.saveTiddler;if(typeof(this.extraparams.tiddler)!="undefined"){e=this.extraparams.tiddler}var c=g.length;var j=DataTiddler.getData(e,"derivations",{});for(name in j){if(name.substr(0,c)==g){k.push(name)}}return k;break;case"moodlesa":var b=this.name;var a=jQuery("#"+b+' .ablock input[type="text"]');var d=a.val();var i="{}";try{i=JSON.parse(d)}catch(f){i={derivations:{},recycled:{}}}if(typeof(i.derivations)=="undefined"){i.derivations={}}k=[];var c=g.length;var j=i.derivations;for(name in j){if(name.substr(0,c)==g){k.push(name)}}return k;break;case"moodledesc":var b=this.name;var a=jQuery("#"+b+" .qtext .data");var d=a.html();var i="{}";try{i=JSON.parse(d)}catch(f){i={derivations:{},recycled:{}}}if(typeof(i.derivations)=="undefined"){i.derivations={}}k=[];var c=g.length;var j=i.derivations;for(name in j){if(name.substr(0,c)==g){k.push(name)}}return k;default:return false}};_.open=function(b){var a=this.getDerivs(b);this.derivation.init(b,a)};_.getDerivs=function(f,c,b){if(typeof(c)=="undefined"){c=this.context}if(typeof(b)=="undefined"){b=this.extraparams.tiddler}var e={};switch(c){case"tiddlywiki":var d=QedEditor.options.TiddlyWiki.saveTiddler;if(typeof(b)!="undefined"){d=b}e[f]=this.getTiddlyDeriv(f,d);var g=this.getDerivsWithPrefix(f+"sub");for(var a=0;a<g.length;++a){e[g[a]]=this.getTiddlyDeriv(g[a],d)}break;case"moodlesa":e[f]=this.getMoodleSADeriv(f);var g=this.getDerivsWithPrefix(f+"sub");for(var a=0;a<g.length;++a){e[g[a]]=this.getMoodleSADeriv(g[a],d)}break;case"moodledesc":e[f]=this.getMoodleDescDeriv(f);var g=this.getDerivsWithPrefix(f+"sub");for(var a=0;a<g.length;++a){e[g[a]]=this.getMoodleDescDeriv(g[a],d)}break;default:e[f]={}}return e};_.getTiddlyDeriv=function(d,c){var e;var a={};a[d]={task:[],assumption:[],observation:[],derivmotivation:[],term:[{text:"",virgin:false}],relation:[],motivation:[],check:""};var b=DataTiddler.getData(c,"derivations",a);if(typeof(b[d])=="undefined"){e=a[d]}else{e=b[d]}return e};_.getMoodleSADeriv=function(e){var a=this.name;var f=jQuery("#"+a+' .ablock input[type="text"]');var d=f.val();var b="{}";try{b=JSON.parse(d)}catch(c){b={derivations:{},recycled:{}}}if(typeof(b.derivations)=="undefined"){b.derivations={}}var g=(typeof(b.derivations[e])!="undefined")?b.derivations[e]:{task:[],assumption:[],observation:[],derivmotivation:[],term:[{text:"",virgin:false}],relation:[],motivation:[],check:""};return g};_.getMoodleDescDeriv=function(e){var a=this.name;var f=jQuery("#"+a+" .qtext .data");var d=f.html();var b="{}";try{b=JSON.parse(d)}catch(c){b={derivations:{},recycled:{}}}if(typeof(b.derivations)=="undefined"){b.derivations={}}var g=(typeof(b.derivations[e])!="undefined")?b.derivations[e]:{task:[],assumption:[],observation:[],derivmotivation:[],term:[{text:"",virgin:false}],relation:[],motivation:[],check:""};return g};_.getDerNames=function(e,c,b){if(typeof(c)=="undefined"){c=this.context}if(typeof(b)=="undefined"){b=this.extraparams.tiddler}var a=[];switch(c){case"tiddlywiki":var d=QedEditor.options.TiddlyWiki.saveTiddler;if(typeof(b)!="undefined"){d=b}a=this.getTiddlyDerNames(e,d);break;case"moodlesa":a=this.getMoodleSADerNames(e);break;case"moodledesc":a=this.getMoodleDescDerNames(e);break;default:break}return a};_.getTiddlyDerNames=function(g,f){var a=[g];var h;var d={};d[g]={task:[],assumption:[],observation:[],derivmotivation:[],term:[{text:"",virgin:false}],relation:[],motivation:[],check:""};var e=DataTiddler.getData(f,"derivations",d);if(typeof(e[g])=="undefined"){h=d[g]}else{h=e[g]}for(var c=0;c<h.observation.length;c++){for(var b=0;b<h.observation[c].motivation.subderiv.length;b++){a=a.concat(this.getTiddlyDerNames(h.observation[c].motivation.subderiv[b],f))}}for(var c=0;c<h.motivation.length;c++){for(var b=0;b<h.motivation[c].subderiv.length;b++){a=a.concat(this.getTiddlyDerNames(h.motivation[c].subderiv[b],f))}}return a};_.getMoodleSADerNames=function(g){var b=this.name;var a=jQuery("#"+b+' .ablock input[type="text"]');var d=a.val();var l="{}";var k=[g];try{l=JSON.parse(d)}catch(e){l={derivations:{},recycled:{}}}if(typeof(l.derivations)=="undefined"){l.derivations={}}var c=(typeof(l.derivations[g])!="undefined")?l.derivations[g]:{task:[],assumption:[],observation:[],derivmotivation:[],term:[{text:"",virgin:false}],relation:[],motivation:[],check:""};for(var h=0;h<c.observation.length;h++){for(var f=0;f<c.observation[h].motivation.subderiv.length;f++){k=k.concat(this.getTiddlyDernames(c.observation[h].motivation.subderiv[f]))}}for(var h=0;h<c.motivation.length;h++){for(var f=0;f<c.motivation[h].subderiv.length;f++){k=k.concat(this.getTiddlyDernames(c.motivation[h].subderiv[f]))}}return k};_.getMoodleDescDerNames=function(g){var b=this.name;var a=jQuery("#"+b+" .qtext .data");var d=a.html();var l="{}";var k=[g];try{l=JSON.parse(d)}catch(e){l={derivations:{},recycled:{}}}if(typeof(l.derivations)=="undefined"){l.derivations={}}var c=(typeof(l.derivations[g])!="undefined")?l.derivations[g]:{task:[],assumption:[],observation:[],derivmotivation:[],term:[{text:"",virgin:false}],relation:[],motivation:[],check:""};for(var h=0;h<c.observation.length;h++){for(var f=0;f<c.observation[h].motivation.subderiv.length;f++){k=k.concat(this.getTiddlyDernames(c.observation[h].motivation.subderiv[f]))}}for(var h=0;h<c.motivation.length;h++){for(var f=0;f<c.motivation[h].subderiv.length;f++){k=k.concat(this.getTiddlyDernames(c.motivation[h].subderiv[f]))}}return k};_.save=function(b){if(typeof(b)=="undefined"){b=this.derivation.name}switch(this.context){case"tiddlywiki":var a=QedEditor.options.TiddlyWiki.saveTiddler;if(typeof(this.extraparams.tiddler)!="undefined"){a=this.extraparams.tiddler}this.saveTiddly(a,b);break;case"moodlesa":this.saveMoodleSA(b);break;case"moodledesc":break;default:return"Invalid context!"}};_.saveTiddly=function(c,d){var b=this.derivation.getSaveData();var f=DataTiddler.getData(c,"derivations",{});for(var a=0;a<b.length;a++){f[b[a].name]=b[a].data;if(typeof(f[b[a].name].plugindata)!="undefined"){b[a].data.plugindata=f[b[a].name].plugindata}}var e=config.options.chkAutoSave;config.options.chkAutoSave=false;DataTiddler.setData(c,"derivations",f);config.options.chkAutoSave=e};_.saveMoodleSA=function(f){if(typeof(f)=="undefined"){f=this.name}var b=f.replace(/sub[0-9]+$/,"");var a=jQuery("#"+b+' .ablock input[type="text"]');var d=a.val();var l="{}";try{l=JSON.parse(d)}catch(e){l={derivations:{},recycled:{}}}if(typeof(l.derivations)=="undefined"){l.derivations={}}var k=this.derivation.getSaveData();for(var g=0;g<k.length;g++){if(typeof(l.derivations[k[g].name])!="undefined"&&typeof(l.derivations[k[g].name].plugindata)!="undefined"){k[g].data.plugindata=l.derivations[k[g].name].plugindata}l.derivations[k[g].name]=k[g].data}d=JSON.stringify(l);a.val(d);if(this.saveajax){var c=$("form#responseform").attr("action")+"#"+b;var j=jQuery('<div class="ajaxanswer"></div>');var h={};h["resp"+b.slice(1)+"_"]=d;h["resp"+b.slice(1)+"_submit"]="Submit";h.timeup=0;h.questionids=b.slice(1);testilogit.ajaxresponse=jQuery.post(c,h)}};_.deleteDeriv=function(c,b){switch(this.context){case"tiddlywiki":if(!b){var a=QedEditor.options.TiddlyWiki.saveTiddler;if(typeof(this.extraparams.tiddler)!="undefined"){a=this.extraparams.tiddler}this.deleteTiddly(a,c)}else{var a=QedEditor.options.TiddlyWiki.recycleTiddler;if(typeof(this.extraparams.tiddler)!="undefined"){a=this.extraparams.tiddler}this.recycleTiddly(a,c)}break;case"moodlesa":if(!b){this.deleteMoodleSA(c)}else{this.recycleMoodleSA(c)}break;case"moodledesc":break;default:return"Invalid context!"}};_.deleteTiddly=function(a,b){var c=DataTiddler.getData(a,"derivations",{});delete c[b];DataTiddler.setData(a,"derivations",c)};_.deleteMoodleSA=function(e){var a=this.name;var f=jQuery("#"+a+' .ablock input[type="text"]');var d=f.val();var b="{}";try{b=JSON.parse(d)}catch(c){b={derivations:{},recycled:{}}}delete b.derivations[this.name];d=JSON.stringify(b);f.val(d)};_.recycleTiddly=function(a,c){var d=DataTiddler.getData(a,"recycled",{});var b=d[this.derivation.name];if(typeof(b)=="undefined"){b=[]}if(b.indexOf(c)==-1){b.push(c)}d[this.derivation.name]=b;DataTiddler.setData(a,"recycled",d)};_.recycleMoodleSA=function(f){var a=this.name;var g=jQuery("#"+a+' .ablock input[type="text"]');var e=g.val();var b="{}";try{b=JSON.parse(e)}catch(c){b={derivations:{},recycled:{}}}if(typeof(b.recycled)=="undefined"){b.recycled={}}var d=b.recycled[this.derivation.name];if(typeof(d)=="undefined"){d=[]}if(d.indexOf(f)==-1){d.push(f)}b.recycled[this.derivation.name]=d;e=JSON.stringify(b);g.val(e)};_.recycleCancel=function(b){switch(this.context){case"tiddlywiki":var a=QedEditor.options.TiddlyWiki.saveTiddler;if(typeof(this.extraparams.tiddler)!="undefined"){a=this.extraparams.tiddler}this.recycleCancelTiddly(a,b);break;case"moodlesa":this.recycleCancelMoodleSA(b);break;default:return"Invalid context!"}};_.recycleCancelTiddly=function(a,c){var e=DataTiddler.getData(a,"recycled",{});var b=(typeof(e[this.derivation.name])!="undefined")?e[this.derivation.name]:[];var d=b.indexOf(c);if(d!=-1){b.splice(d,1)}if(b.length==0){delete e[this.derivation.name]}DataTiddler.setData(a,"recycled",e)};_.recycleCancelMoodleSA=function(f){var a=this.name;var h=jQuery("#"+a+' .ablock input[type="text"]');var e=h.val();var b="{}";try{b=JSON.parse(e)}catch(c){b={derivations:{},recycled:{}}}if(typeof(b.recycled)=="undefined"){b.recycled={}}var d=b.recycled[this.derivation.name];if(typeof(d)=="undefined"){d=[]}var g=d.indexOf(f);if(g!=-1){d.splice(g,1)}if(d.length==0){delete b.recycled[this.derivation.name]}else{b.recycled[this.derivation.name]=d}e=JSON.stringify(b);h.val(e)};_.cleanRecycleBin=function(){switch(this.context){case"tiddlywiki":var a=QedEditor.options.TiddlyWiki.recycleTiddler;if(typeof(this.extraparams.tiddler)!="undefined"){a=this.extraparams.tiddler}this.cleanRecycleBinTiddly(a);break;default:break}};_.cleanRecycleBinTiddly=function(c){var a=DataTiddler.getData(c,"recycled",{});var d=a[this.derivation.name];for(var b=0;b<d.length;b++){this.deleteDeriv(d[b])}delete a[this.derivation.name];DataTiddler.setData(c,"recycled",a)};QedEditor.oprHandler=function(o){var a=jQuery(this).parents("div.qededitor");var d=o.data.loc.replace(/_motivation$/,"").split("_"+o.data.splitelem+"_");var h=parseInt(d.pop());var p=d.join("_"+o.data.splitelem+"_");testilogit.data=o.data;var c=a[0].editor.derivation.findLocation(p);var g=["",""];switch(o.data.oper){case"add":switch(o.data.elem){case"task":var n=c.term[0].text.replace(/\\text{([^{}]*)}/g,"$$$1$$");n=("$"+n+"$").replace(/\$\$/g,"");g=[n,""];h=0;a[0].editor.nextFocus=p+"_task_0";break;case"taskass":var n=c.term[0].text.replace(/\\text{([^{}]*)}/g,"$$$1$$");n=("$"+n+"$").replace(/\$\$/g,"");g=[n,c.term[0].text];h=0;a[0].editor.nextFocus=p+"_assumption_0";break;case"taskobs":var n=c.term[0].text.replace(/\\text{([^{}]*)}/g,"$$$1$$");n=("$"+n+"$").replace(/\$\$/g,"");g=[n,c.term[0].text];h=0;a[0].editor.nextFocus=p+"_observation_0_motivation";break;case"assumption":if(o.data.splitelem=="task"){h=0}else{h=h+1}a[0].editor.nextFocus=p+"_assumption_"+h;break;case"observation":if(o.data.splitelem=="task"||o.data.splitelem=="assumption"){h=0}else{h=h+1}a[0].editor.nextFocus=p+"_observation_"+h+"_motivation";break;case"step":var q="";if(h<1){q=(typeof(c.relation[0])!="undefined")?c.relation[0].text:""}else{if(h>c.relation.length-1){q=c.relation[c.relation.length-1].text}else{q=c.relation[h-1].text}}var r={text:"",subders:[]};var k=c.term[h].text;g=[{relation:q,motivation:r,term:k},""];if(q==""){a[0].editor.nextFocus=p+"_relation_"+h}else{a[0].editor.nextFocus=p+"_motivation_"+h}break;case"subderivation":if(o.data.splitelem=="motivation"||o.data.splitelem=="observation"){p=o.data.loc;h=0}else{if(o.data.splitelem=="term"){d=p.split("_subderivation_");h=parseInt(d.pop())+1;p=d.join("_subderivation_")}else{p=o.data.loc.replace(/_subderivation_[0-9]+$/,"");h=parseInt(d[d.length-1])+1}}a[0].editor.nextFocus=p+"_subderivation_"+h+"_term_0";break;case"derivationmotivation":a[0].editor.nextFocus=p+"_derivmotivation_0";break;default:alert(o.data.oper+"\n"+o.data.elem);break}break;case"remove":switch(o.data.elem){case"task":g=["",c.task[0].text];h=0;a[0].editor.nextFocus=p+"_term_0";break;case"taskass":g=["",c.task[0].text];h=0;a[0].editor.nextFocus=p+"_term_0";break;case"taskobs":g=["",c.task[0].text];h=0;a[0].editor.nextFocus=p+"_term_0";break;case"assumption":g=["",c.assumption[h].text];if(c.assumption.length==1){a[0].editor.nextFocus=p+"_task_0"}else{if(c.assumption.length>h+1){a[0].editor.nextFocus=p+"_assumption_"+h}else{a[0].editor.nextFocus=p+"_assumption_"+(h-1)}}break;case"observation":g=["",c.observation[h]];if(c.observation.length==1){if(c.assumption.length>0){a[0].editor.nextFocus=p+"_assumption_"+(c.assumption.length-1)}else{a[0].editor.nextFocus=p+"_task_0"}}else{if(c.observation.length>h+1){a[0].editor.nextFocus=p+"_observation_"+h}else{a[0].editor.nextFocus=p+"_observation_"+(h-1)}}break;case"step":var j=c.relation[h].text;var m={text:c.motivation[h].text,subders:[]};for(var f=0;f<c.motivation[h].subderivation.length;f++){m.subders.push(c.motivation[h].subderivation[f].name)}var s=c.term[h+1].text;g=["",{relation:j,motivation:m,term:s}];a[0].editor.nextFocus=p+"_term_"+h;break;case"derivationmotivation":g=["",c.derivmotivation[0].text];a[0].editor.nextFocus=p+"_term_0";break;case"subderivation":d=p.split("_subderivation_");h=parseInt(d.pop());p=d.join("_subderivation_");var b=a[0].editor.derivation.findLocation(p).subderivation[h].name;g=["",b];a[0].editor.nextFocus=p;break;default:alert(o.data.oper+"\n"+o.data.elem);break}break;case"undo":case"redo":p="";h="";g=["",""];break;default:break}var l=new EditorEvent(o.data.oper,o.data.elem,p,h,g);a[0].editor.doEvent(l);jQuery("#qededitormenuwrapper").remove();return false};_.installPlugins=function(){for(var a=0;a<QedEditor.plugins.length;a++){if(typeof(QedEditor.plugins[a])!="undefined"){this.plugins.push(QedEditor.plugins[a].use(this))}}};_.pluginButtons=function(){var b="";for(var a=0;a<this.plugins.length;a++){b+=this.plugins[a].html()}return b};_.initPlugins=function(){var b=jQuery(this.element).find(".qededitorbuttons .pluginbuttons");for(var c=0;c<this.plugins.length;c++){try{this.plugins[c].init()}catch(f){}var d=b.eq(c).find("li.pluginitem a.pluginbutton");for(var a=0;a<this.plugins[c].buttons.length;a++){var g={editor:this,plugin:this.plugins[c]};d.eq(a).click(function(){jQuery(this).parents("ul").eq(0).hide();setTimeout("jQuery('.pluginbuttons ul').attr('style','')",500);return false});d.eq(a).click(g,this.plugins[c].buttons[a].action)}}};function QedEditorMenu(a){this.menuitems=[];var c;for(var b=0;b<a.plus.length;b++){c=new QedEditorMenuItem("plus",a.plus[b]);this.menuitems.push(c)}for(var b=0;b<a.minus.length;b++){c=new QedEditorMenuItem("minus",a.minus[b]);this.menuitems.push(c)}if(a.undo){c=new QedEditorMenuItem("undo","Undo");this.menuitems.push(c)}if(a.redo){c=new QedEditorMenuItem("redo","Redo");this.menuitems.push(c)}}_=QedEditorMenu.prototype;_.html=function(){var a="";for(var b=0;b<this.menuitems.length;b++){a+=this.menuitems[b].html()}a='<ul id="qededitormenu">\n'+a+"</ul>\n";return a};_.menuInit=function(){jQuery("#qededitormenu").parents("td").eq(0).find(".mathquill-editable").blur().focusout();jQuery("#qededitormenu a").eq(0).focus();jQuery("#qededitormenu li").eq(0).addClass("selected");jQuery("#qededitormenu li").each(function(){var a=jQuery(this).parents("tr").eq(0).find("td").eq(1);if(a.attr("class").match(/relation/gi)=="relation"){var c="relation";var b=a.attr("loc")}else{var c=a.attr("class").match(/(task|term|relation|motivation|assumption|observation|obsmotivation|derivmotivation|subderivation)/gi)[0].replace("obsmotivation","observation");var b=a.attr("loc")}var f={"+":"add","–":"remove","↶":"undo","↷":"redo"};var g=f[jQuery(this).find(".menuoperation").html()];var d=jQuery(this).find(".menuname").html();var e={oper:g,elem:d,loc:b,splitelem:c};jQuery(this).click(e,QedEditor.oprHandler);jQuery(this).mouseenter(function(){jQuery(this).addClass("selected")});jQuery(this).mouseleave(function(){jQuery(this).removeClass("selected")});jQuery(this).keydown(function(h){if(h.keyCode==13||h.keyCode==38||h.keyCode==40||h.keyCode==27||h.keyCode==9){h.stopPropagation();h.preventDefault()}});jQuery(this).keypress(function(h){if(h.keyCode==13||h.keyCode==38||h.keyCode==40||h.keyCode==27||h.keyCode==9){h.stopPropagation();h.preventDefault()}});jQuery(this).keyup(function(i){var h=jQuery(this).parent().find("li");var j=h.index(jQuery(this));switch(i.keyCode){case 40:h.removeClass("selected");h.eq((j+1)%h.length).addClass("selected").find("a").focus();i.stopPropagation();i.preventDefault();break;case 38:h.removeClass("selected");h.eq((j-1)%h.length).addClass("selected").find("a").focus();i.stopPropagation();i.preventDefault();break;case 13:i.stopPropagation();i.preventDefault();jQuery(this).click();break;case 27:jQuery("#qededitormenuwrapper").remove();QedEditor.buttonpanel.lastfocus.focus();i.stopPropagation();i.preventDefault();break;case 9:i.preventDefault();i.stopPropagation();default:break}})});jQuery("#qededitormenuwrapper.minus, #qededitormenuwrapper.plus").mouseleave(function(){jQuery("#qededitormenuwrapper").remove()})};function QedEditorMenuItem(a,c,b){this.operation=a;this.sdelement=c;if(typeof(b)=="undefined"){this.label="";this.label=c}else{this.label=b}}_=QedEditorMenuItem.prototype;_.html=function(){var b=["qededitormenuitem"];b.push(this.sdelement);b.push(this.operation);var c="";switch(this.operation){case"plus":c="+";break;case"minus":c="–";break;case"undo":c="↶";break;case"redo":c="↷";break;default:c=this.operation;break}var a="";testilogit.sdelement=this.sdelement;a+='<li class="'+b.join(" ")+'">\n<a href="javascript:;"><span class="menuoperation">'+c+'</span><span class="menulabel">'+QedEditor.locales[this.label][QedEditor.options.lang]+'</span><span class="menuname">'+this.sdelement+"</span></a>\n</li>\n";return a};function SdDerivation(a,b){this.editor=b;this.name="";this.task=[];this.assumption=[];this.observation=[];this.derivmotivation=[];this.term=[];this.relation=[];this.motivation=[];this.check="";this.context=a}SdDerivation.options={};SdDerivation.options.TiddlyWiki={saveTiddler:"QedDerivationsData",recycleTiddler:"QedDerivationsRecycleBin"};SdDerivation.alphatonum=function(c){var b=0;for(var a=0;a<c.length;a++){if(c.length>1&&a==0){b+=c.charCodeAt(a)-96}else{b=26*b;b+=c.charCodeAt(a)-97}}return b};SdDerivation.numtoalpha=function(b){var c=0;var a="";while(a==""||b>25){c=b%26;a=String.fromCharCode(c+97)+a;b=Math.floor(b/26)}if(b>0){c=b%26;a=String.fromCharCode(c+96)+a}return a};SdDerivation.shiftLabel=function(a,b){if(b===undefined){b=1}ll=SdDerivation.alphatonum(a);ll+=b;result=SdDerivation.numtoalpha(ll);return result};_=SdDerivation.prototype;_.name="";_.task=[];_.assumption=[];_.observation=[];_.derivmotivation=[];_.term=[];_.relation=[];_.motivation=[];_.check="";_.hidden=false;_.context="";_.init=function(j,m){var h={task:[],assumption:[],observation:[],derivmotivation:[],term:[{text:"",virgin:false}],relation:[],motivation:[],check:""};var f=m[j];if(typeof(f)=="undefined"){f=h}this.name=j;if(f.task.length>0){var d=new SdTask(f.task[0]);this.task=[d]}else{this.task=[]}this.assumption=[];for(var k=0;k<f.assumption.length;k++){var c=new SdAssumption(f.assumption[k].label,f.assumption[k].text);this.assumption.push(c)}this.observation=[];for(var k=0;k<f.observation.length;k++){var b=new SdObservation(f.observation[k].label,f.observation[k].motivation,f.observation[k].text,this.context,this,m);this.observation.push(b)}this.derivmotivation=[];if(f.derivmotivation.length>0){var e=new SdMotivation(f.derivmotivation[0].text,f.derivmotivation[0].subderiv,false,"derivation",this.context,this,m);this.derivmotivation.push(e)}this.term=[];for(var k=0;k<f.term.length;k++){var g=new SdTerm(f.term[k].text,f.term[k].virgin);this.term.push(g)}this.relation=[];for(var k=0;k<f.relation.length;k++){var l=new SdRelation(f.relation[k].text,f.term[k].virgin);this.relation.push(l)}this.motivation=[];for(var k=0;k<f.motivation.length;k++){var a=new SdMotivation(f.motivation[k].text,f.motivation[k].subderiv,f.motivation[k].virgin,"step",this.context,this,m);this.motivation.push(a)}this.check=f.check;this.hidden=f.hidden};_.getSaveData=function(){var a={};var e=[];a.task=[];for(var c=0;c<this.task.length;c++){a.task.push(this.task[c].getSaveData())}a.assumption=[];for(var c=0;c<this.assumption.length;c++){a.assumption.push(this.assumption[c].getSaveData())}a.observation=[];for(var c=0;c<this.observation.length;c++){a.observation.push(this.observation[c].getSaveData());var d=this.observation[c].getSubSaveData();for(var b=0;b<d.length;b++){e.push(d[b])}}a.derivmotivation=[];for(var c=0;c<this.derivmotivation.length;c++){a.derivmotivation.push(this.derivmotivation[c].getSaveData());var d=this.derivmotivation[c].getSubSaveData();for(var c=0;c<d.length;c++){e.push(d[c])}}a.term=[];for(var c=0;c<this.term.length;c++){a.term.push(this.term[c].getSaveData())}a.relation=[];for(var c=0;c<this.relation.length;c++){a.relation.push(this.relation[c].getSaveData())}a.motivation=[];for(var c=0;c<this.motivation.length;c++){a.motivation.push(this.motivation[c].getSaveData());var d=this.motivation[c].getSubSaveData();for(var b=0;b<d.length;b++){e.push(d[b])}}a.check=this.check;a.hidden=this.hidden;e.push({name:this.name,data:a});return e};_.findLocation=function(d){var e=d.split("_");e.shift();var b=this;var a="";var c="";while(e.length>0){if(c=="observation"&&e[0]=="motivation"&&/^[0-9]+$/.test(e[1])){c=a;a=e.shift();e.shift()}else{c=a;a=e.shift()}b=b[a]}return b};_.addTask=function(a){if(typeof(a)=="string"){a=new SdTask(a)}this.task=[a]};_.removeTask=function(){this.task=[]};_.addStep=function(g,d){if(typeof(d)=="undefined"){var e={text:"",subderiv:[]};d={relation:"",motivation:e,term:""}}var b=(d.relation==""||d.relation==" ");var c=new SdRelation(d.relation,b);var f=new SdMotivation(d.motivation.text,d.motivation.subders,true,"step",this.context,this,{});var a=new SdTerm(d.term,true);this.term.splice(parseInt(g)+1,0,a);this.relation.splice(g,0,c);this.motivation.splice(g,0,f)};_.removeStep=function(a){this.relation.splice(a,1);this.motivation.splice(a,1);this.term.splice(parseInt(a)+1,1)};_.addAssumption=function(e,c){if(typeof(c)=="undefined"){c=""}var a=SdDerivation.numtoalpha(e);var d=new SdAssumption(a,c);for(var b=e;b<this.assumption.length;b++){this.assumption[b].shiftLabel(1)}this.assumption.splice(e,0,d)};_.removeAssumption=function(b){for(var a=b+1;a<this.assumption.length;a++){this.assumption[a].shiftLabel(-1)}this.assumption.splice(b,1)};_.addObservation=function(e,b){if(e>=this.observation.length){var a=this.observation.length+1}else{var a=this.observation[e].label}if(typeof(b)=="undefined"||b==""){var d={text:"",subderiv:[]};var b=new SdObservation(a,d,"",this.context,this,{})}for(var c=e;c<this.observation.length;c++){this.observation[c].shiftLabel(1)}this.observation.splice(e,0,b)};_.removeObservation=function(b){for(var a=b+1;a<this.observation.length;a++){this.observation[a].shiftLabel(-1)}this.observation.splice(b,1)};_.addDermot=function(a){if(typeof(a)=="undefined"){a=""}var b=new SdMotivation(a,[],true,"derivation",this.context,this,{});this.derivmotivation=[b]};_.removeDermot=function(){this.derivmotivation=[]};_.addSubderivation=function(f,h,d){if(typeof(d)=="undefined"||d==""){var e=f.split("_");d=e[0]+"sub";var c=0;var a=false;var b=10000;while(!a&&c<b){if(this.editor.derivationExists(d+c)){c++}else{a=true}}d=d+c}var g=this.findLocation(f);g.addSubderivation(d,h,this.context)};_.addSubderivationObject=function(b,d,a){var c=this.findLocation(b);c.addSubderivationObject(a,d)};_.removeSubderivation=function(c,e){var d=this.findLocation(c);var a=c.split("_")[0];var b=d.removeSubderivation(e,a);return b};_.html=function(g,f){f=(typeof(f)==="undefined")?this.name:f;var e="";var l="";if(!this.issubderivation){if(g=="edit"){}else{if(g=="showcontent"){g="show";e+='<a href="javascript:;" class="button command_qededit"></a>\n';e='<div class="qededitorbuttons">\n'+e+"</div>\n"}else{e+='\n<div class="structuredderivation" sdname="'+this.name+'">\n';e+='<a href="javascript:;" class="button command_qededit"></a>\n<div class="sdbackground">\n';e='<div class="qededitorbuttons">\n'+e+"</div>\n";l="</div>\n</div>"}}}var n=e;n+='<table class="sdtable">\n<tbody>\n';var h="";var b=["task","assumption","observation","derivmotivation"];for(var c=0;c<b.length;c++){for(var a=0;a<this[b[c]].length;a++){switch(b[c]){case"task":h={ass:(this.assumption.length>0),obs:(this.observation.length>0),dermot:(this.derivmotivation.length>0),issub:this.issubderivation};break;case"assumption":h={last:(a==this.assumption.length-1)};break;case"observation":h={};break;case"derivmotivation":h={};break;default:h={}}n+=this[b[c]][a].html(g,f+"_"+b[c]+"_"+a,h)}}if(this.term.length>0){var k=(this.term.length==1&&this.issubderivation);if(this.task.length>0){if(this.derivmotivation.length>0){n+=this.term[0].html(g,f+"_term_0",{termtype:"",last:k})}else{n+=this.term[0].html(g,f+"_term_0",{termtype:"vdash",last:k})}}else{var d=this.issubderivation;n+=this.term[0].html(g,f+"_term_0",{termtype:"bullet",last:k,first:d})}for(var c=0;c<this.motivation.length;c++){n+=this.relation[c].html(g,f+"_relation_"+c);n+=this.motivation[c].html(g,f+"_motivation_"+c);k=(c==this.motivation.length-1&&this.issubderivation);if(this.motivation[c].subderivation.length>0){n+=this.term[c+1].html(g,f+"_term_"+(c+1),{termtype:"ldots",last:k})}else{n+=this.term[c+1].html(g,f+"_term_"+(c+1),{termtype:"",last:k})}}}if(!(this.issubderivation)){var m="<tr><td>$\\square$</td><td></td></tr>";if(g=="show"||g=="edit"){m=m.replace(/\$([^\$]+)\$/g,'<span class="mathquill-embedded-latex">$1</span>')}n+=m}n+="</tbody>\n</table>\n";n+=l;return n};_.lyx=function(f){f=(typeof(f)==="undefined")?this.name:f;var e="";var k="";if(!this.issubderivation){e="";k=""}var m=e;m+='<table class="sdtable">\n<tbody>\n';var g="";var a=["task","assumption","observation","derivmotivation"];for(var c=0;c<a.length;c++){for(var b=0;b<this[a[c]].length;b++){switch(a[c]){case"task":g={ass:(this.assumption.length>0),obs:(this.observation.length>0),dermot:(this.derivmotivation.length>0),issub:this.issubderivation};break;case"assumption":g={last:(b==this.assumption.length-1)};break;case"observation":g={};break;case"derivmotivation":g={};break;default:g={}}m+=this[a[c]][b].lyx(f+"_"+a[c]+"_"+b,g)}}if(this.term.length>0){var h=(this.term.length==1&&this.issubderivation);if(this.task.length>0){if(this.derivmotivation.length>0){m+=this.term[0].lyx(f+"_term_0",{termtype:"",last:h})}else{m+=this.term[0].lyx(f+"_term_0",{termtype:"vdash",last:h})}}else{var d=this.issubderivation;m+=this.term[0].lyx(f+"_term_0",{termtype:"bullet",last:h,first:d})}for(var c=0;c<this.motivation.length;c++){m+=this.relation[c].lyx(f+"_relation_"+c);m+=this.motivation[c].lyx(f+"_motivation_"+c);h=(c==this.motivation.length-1&&this.issubderivation);if(this.motivation[c].subderivation.length>0){m+=this.term[c+1].lyx(f+"_term_"+(c+1),{termtype:"ldots",last:h})}else{m+=this.term[c+1].lyx(f+"_term_"+(c+1),{termtype:"",last:h})}}}if(!(this.issubderivation)){var l="<tr><td>$\\square$</td><td></td></tr>";m+=l}m+="</tbody>\n</table>\n";m+=k;return m};_.json=function(){return JSON.stringify(this.jsonobject())};_.jsonobject=function(){var b={};b.derivations=[];var a={};a.name=this.name;a.task=[];for(var c=0;c<this.task.length;c++){a.task.push(this.task[c].jsonobject())}a.assumptions=[];for(var c=0;c<this.assumption.length;c++){a.assumptions.push(this.assumption[c].jsonobject())}a.observations=[];for(var c=0;c<this.observation.length;c++){a.observations.push(this.observation[c].jsonobject())}a.chain={};a.chain["terms"]=[];for(var c=0;c<this.term.length;c++){a.chain["terms"].push(this.term[c].jsonobject())}a.chain["relations"]=[];for(var c=0;c<this.relation.length;c++){a.chain["relations"].push(this.relation[c].jsonobject())}a.chain["motivations"]=[];for(var c=0;c<this.motivation.length;c++){a.chain["motivations"].push(this.motivation[c].jsonobject())}b.derivations.push(a);return b};_.eventDo=function(b){var a=false;switch(b.event){case"add":switch(b.item){case"task":var d=this.findLocation(b.location);d.addTask(b.newData());a=true;break;case"taskass":var d=this.findLocation(b.location);d.addTask(b.newData());d.addAssumption(0,"");if(d.term.length==1){d.term[0].text=""}a=true;break;case"taskobs":var d=this.findLocation(b.location);d.addTask(b.newData());d.addObservation(0,"");if(d.term.length==1){d.term[0].text=""}a=true;break;case"assumption":var d=this.findLocation(b.location);d.addAssumption(b.position,b.newData());a=true;break;case"observation":var d=this.findLocation(b.location);d.addObservation(b.position,b.newData());a=true;break;case"derivationmotivation":var d=this.findLocation(b.location);d.addDermot(b.newData());a=true;break;case"step":var d=this.findLocation(b.location);d.addStep(b.position,b.newData());a=true;break;case"subderivation":if(b.newData()==""){this.addSubderivation(b.location,b.position,b.newData())}else{this.addSubderivationObject(b.location,b.position,b.newData())}a=true;break;default:a=true;break}break;case"remove":switch(b.item){case"task":var d=this.findLocation(b.location);d.removeTask();a=true;break;case"taskass":var d=this.findLocation(b.location);d.removeTask();d.removeAssumption(0);if(d.term.length==1){d.term[0].text=b.newData()}a=true;break;case"taskobs":var d=this.findLocation(b.location);d.removeTask();d.removeObservation(0);if(d.term.length==1){d.term[0].text=b.newData()}a=true;break;case"assumption":var d=this.findLocation(b.location);d.removeAssumption(b.position);a=true;break;case"observation":var d=this.findLocation(b.location);d.removeObservation(b.position);a=true;break;case"derivationmotivation":var d=this.findLocation(b.location);d.removeDermot();a=true;break;case"step":var d=this.findLocation(b.location);d.removeStep(b.position);a=true;break;case"subderivation":a=this.removeSubderivation(b.location,b.position);break;default:a=true;break}break;case"edit":var c=this.findLocation(b.location);if(typeof(c.virgin)!="undefined"&&c.virgin){c.virgin=false}c.text=b.newData();a=true;break;default:break;a=true}return a};function SdSubDeriv(d,a,c,b){if(typeof(b)=="undefined"){var b={}}this.editor=c;this.name="";this.task=[];this.assumption=[];this.observation=[];this.derivmotivation=[];this.term=[];this.relation=[];this.motivation=[];this.check="";this.hidden=false;this.issubderivation=true;this.context=a;this.init(d,b)}_=SdSubDeriv.prototype=new SdDerivation;_.htmlSub=function(d,c){var a=this.html(d,c);var b="sdsubderivation";if(this.hidden){b+=" sdhiddensub"}a='\n\n\n<div class="'+b+'">\n'+a+"</div>\n\n\n";return a};_.lyxSub=function(b){var a=this.lyx(b);a='\n\n\n<div class="">\n'+a+"</div>\n\n\n";return a};function SdTask(a){this.text=a}_=SdTask.prototype;_.text="";_.json=function(){return JSON.stringify(this.jsonobject())};_.jsonobject=function(){return this.text};_.html=function(g,d,h){var a="$\\bullet$";var c="";var f="";var i=[];var e=[];if(!(h===undefined)){if(!(h.ass||h.obs||h.dermot)){i.push("task")}if(h.ass){e.push("assumption")}else{e.push("assumption");e.push("observation")}if(h.issub){i.push("subderivation")}if(i.length>0){c='<a href="javascript:;" class="sdremovebutton"><span>–</span></a>'}if(e.length>0){f='<a href="javascript:;" class="sdaddbutton""><span>+</span></a>'}}i='<span class="minusbuttons" menuitems="'+i.join(" ")+'"></span>';e='<span class="plusbuttons" menuitems="'+e.join(" ")+'"></span>';c='<div class="sdbeforebuttons">'+i+c+"</div>";f='<div class="sdafterbuttons">'+e+f+"</div>";var b=["task"];if(g=="show"||g=="edit"){a=a.replace(/\$([^\$]+)\$/g,'<span class="mathquill-embedded-latex">$1</span>');addbuttons=""}var j=this.text;if(g=="show"){j=j.replace(/\$([^\$]+)\$/g,'<span class="mathquill-embedded-latex">$1</span>')}else{if(g=="edit"){j='<span class="mathquill-textbox">'+j+"</span>"}}j='<tr><td class="bullet">'+c+a+'</td><td class="'+b.join(" ")+'" loc="'+d+'">'+j+f+"</td></tr>\n";return j};_.lyx=function(d,c){var b="$\\bullet$";var a=this.text;a='<tr><td class="bullet">'+b+'</td><td class= loc="'+d+'">'+a+"</td></tr>\n";return a};_.getSaveData=function(){return this.text};function SdAssumption(a,b){this.label=a;this.text=b;this.virgin=false;if(b==""){this.virgin=true}}_=SdAssumption.prototype;_.label="";_.text="";_.json=function(){return JSON.stringify(this.jsonobject())};_.jsonobject=function(){return[this.label,this.text]};_.shiftLabel=function(a){if(a===undefined){a=1}this.label=SdDerivation.shiftLabel(this.label,a)};_.html=function(f,c,g){var i=this.text;var h=[];var d=[];h.push("assumption");d.push("assumption");if(!(g===undefined)){if(g.last){e+='<a href="javascript:;" class="addobservation sdaddbutton" title="add observation"><span>[+]</span></a>';d.push("observation")}}var b='<a href="javascript:;" class="sdremovebutton"><span>–</span></a>';var e='<a href="javascript:;" class="sdaddbutton"><span>+</span></a>';h='<span class="minusbuttons" menuitems="'+h.join(" ")+'"></span>';d='<span class="plusbuttons" menuitems="'+d.join(" ")+'"></span>';b='<div class="sdbeforebuttons">'+h+b+"</div>";e='<div class="sdafterbuttons">'+d+e+"</div>";if(f=="show"){i=i.replace(/\$([^\$]+)\$/g,'<span class="mathquill-embedded-latex">$1</span>')}else{if(f=="edit"){i='<span class="mathquill-textbox">'+i+"</span>"}}var a=this.virgin?" virgin":"";i="<tr><td>"+b+"("+this.label+')</td><td class="assumption'+a+'" loc="'+c+'">'+i+e+"</td></tr>\n";return i};_.lyx=function(c,b){var a=this.text;a='<span class="mathquill-textbox">'+a+"</span>";a="<tr><td>("+this.label+')</td><td class="assumption" loc="'+c+'">'+a+"</td></tr>\n";return a};_.getSaveData=function(){return{label:this.label,text:this.text}};function SdObservation(c,g,b,d,f,e){if(g===undefined){g={text:"",subderiv:[]}}if(b===undefined){b=""}if(d===undefined){d=""}var a=false;if(g.text==""){a=true}this.virgin=false;if(b==""){this.virgin=true}this.parent=f;this.label=c;this.motivation=new SdMotivation(g.text,g.subderiv,a,"observation",d,this.parent,e);this.text=b}_=SdObservation.prototype;_.label="";_.motivation=new SdMotivation;_.text="";_.json=function(){return JSON.stringify(this.jsonobject())};_.jsonobject=function(){return[this.label,this.motivation.jsonobject(),this.text]};_.shiftLabel=function(a){if(a===undefined){a=1}this.label=this.label+a};_.html=function(f,c,g){if(g===undefined){g={}}var h=[];var d=[];var b="";var e="";var l=this.motivation.html(f,c+"_motivation");h.push("observation");d.push("observation");var b='<a href="javascript:;" class="sdremovebutton"><span>–</span></a>';var e='<a href="javascript:;" class="sdaddbutton"><span>+</span></a>';h='<span class="minusbuttons" menuitems="'+h.join(" ")+'"></span>';d='<span class="plusbuttons" menuitems="'+d.join(" ")+'"></span>';b='<div class="sdbeforebuttons">'+h+b+"</div>";e='<div class="sdafterbuttons">'+d+e+"</div>";l="<tr><td>"+b+"["+this.label+"]</td>"+l+"</tr>\n";var a="";var k="";if(this.motivation.subderivation.length>0){a='<span class="mathquill-embedded-latex">\\ldots</span>';k="ldots"}var j=this.text;if(f=="show"){j=j.replace(/\$([^\$]+)\$/g,'<span class="mathquill-embedded-latex">$1</span>')}else{if(f=="edit"){j='<span class="mathquill-textbox">'+j+"</span>"}}var i=this.virgin?" virgin":"";j='<tr><td class="'+k+'">'+a+'</td><td class="observation'+i+'" loc="'+c+'">'+j+e+"</td></tr>\n";var m=l+j;return m};_.lyx=function(f,b){if(b===undefined){b={}}var e=this.motivation.html(editmode,f+"_motivation");e="<tr><td>"+beforebuttons+"["+this.label+"]</td>"+e+"</tr>\n";var c="";if(this.motivation.subderivation.length>0){c='<span class="mathquill-embedded-latex">\\ldots</span>'}var d=this.text;d='<span class="mathquill-textbox">'+d+"</span>";d='<tr><td class="'+tdclass+'">'+c+'</td><td class="observation'+obsclass+'" loc="'+f+'">'+d+afterbuttons+"</td></tr>\n";var a=e+d;return a};_.getSubSaveData=function(){return this.motivation.getSubSaveData()};_.getSaveData=function(){return{label:this.label,motivation:this.motivation.getSaveData(),text:this.text,virgin:this.virgin}};function SdTerm(b,a){this.text=b;if(typeof(a)=="undefined"){a=false}this.virgin=a}_=SdTerm.prototype;_.text="";_.json=function(){return JSON.stringify(this.jsonobject())};_.jsonobject=function(){return"$"+this.text+"$"};_.html=function(g,d,h){if(h===undefined){h={termtype:""}}var b=[];if(this.virgin){b.push("virgin")}b.push("term");var j="";var c="";var f="";var a="";var i=[];var e=[];if(h.termtype=="bullet"){j="$\\bullet$";e.push("task");e.push("taskass");e.push("taskobs");if(h.first){i.push("subderivation")}}else{if(h.termtype=="vdash"){j="$\\Vdash$";e.push("derivationmotivation")}else{if(h.termtype=="ldots"){j="$\\ldots$"}}}if(g=="show"||g=="edit"){j=j.replace(/\$([^\$]+)\$/g,'<span class="mathquill-embedded-latex">$1</span>')}var k="$ "+this.text+"$";if(g=="show"){k=k.replace(/\$([^\$]*)\$/g,'<span class="mathquill-embedded-latex">$1</span>')}else{if(g=="edit"){k=k.replace(/\$([^\$]*)\$/g,'<span class="mathquill-editable">$1</span>');e.push("step")}}if(h.last){e.push("subderivation")}if(i.length>0){c='<a href="javascript:;" class="sdremovebutton"><span>–</span></a>'}if(e.length>0){f='<a href="javascript:;" class="sdaddbutton"><span>+</span></a>'}i='<span class="minusbuttons" menuitems="'+i.join(" ")+'"></span>';e='<span class="plusbuttons" menuitems="'+e.join(" ")+'"></span>';c='<div class="sdbeforebuttons">'+i+c+"</div>";f='<div class="sdafterbuttons">'+e+f+"</div>";k='<tr><td class="'+h.termtype+'">'+c+j+'</td><td class="'+b.join(" ")+'" loc="'+d+'">'+k+a+f+"</td></tr>\n";return k};_.lyx=function(d,c){if(c===undefined){c={termtype:""}}var b="";if(c.termtype=="bullet"){b="$\\bullet$"}else{if(c.termtype=="vdash"){b="$\\Vdash$"}else{if(c.termtype=="ldots"){b="$\\ldots$"}}}var a="$ "+this.text+"$";a='<tr><td class="'+c.termtype+'">'+b+'</td><td class="'+tdclasses.join(" ")+'" loc="'+d+'">'+a+"</td></tr>\n";return a};_.getSaveData=function(){return{text:this.text,virgin:this.virgin}};function SdRelation(a,b){this.text=a;if(typeof(b)=="undefined"){b=false}this.virgin=b}_=SdRelation.prototype;_.text="";_.json=function(){return JSON.stringify(this.jsonobject())};_.jsonobject=function(){return"$"+this.text+"$"};_.html=function(h,g,d){if(d===undefined){d={}}var e=[];var f="";var c="";var b=[];if(this.text!=""){this.virgin=false}if(this.virgin){e.push("virgin")}e.push("relation");var a="$ "+this.text+"$";if(h=="show"){a=a.replace(/\$([^\$]+)\$/g,'<span class="mathquill-embedded-latex">$1</span>')}else{if(h=="edit"){a=a.replace(/\$([^\$]+)\$/g,'<span class="mathquill-editable">$1</span>');b.push("step")}}if(b.length>0){f+='<a href="javascript:;" class="sdremovebutton"><span>–</span></a>'}b='<span class="minusbuttons" menuitems="'+b.join(" ")+'"></span>';f='<div class="sdbeforebuttons">'+b+f+"</div>";a='<tr><td class="'+e.join(" ")+'" loc="'+g+'">'+f+a+"</td>\n";return a};_.lyx=function(c,b){if(b===undefined){b={}}var a="$ "+this.text+"$";a='<tr><td class="" loc="'+c+'">'+a+"</td>\n";return a};_.getSaveData=function(){return{text:this.text,virgin:this.virgin}};function SdMotivation(c,h,d,f,a,g,j){this.parent=g;this.text=c;this.subderivation=[];this.mottype=f;if(typeof(d)=="undefined"){d=false}this.virgin=d;if(!(h===undefined)&&!!h){for(var e=0;e<h.length;e++){var b=new SdSubDeriv(h[e],a,this.parent.editor,j);this.subderivation.push(b)}}}_=SdMotivation.prototype;_.text="";_.subderivation=[];_.json=function(){return JSON.stringify(this.jsonobject())};_.jsonobject=function(){var a=[this.text];for(var b=0;b<this.subderivation.length;b++){a.push(this.subderivation[b].jsonobject())}return a};_.html=function(l,g,m){if(m===undefined){m={}}var c=[];var e="";var k="";var n=[];var j=[];if(this.virgin){c.push("virgin")}var h="motivation";var b="";if(this.mottype=="observation"){h="obsmotivation"}else{if(this.mottype=="derivation"){n.push("derivationmotivation");e='<a href="javascript:;" class="sdremovebutton"><span>–</span></a>';n='<span class="minusbuttons" menuitems="'+n.join(" ")+'"></span>';e='<div class="sdbeforebuttons">'+n+e+"</div>";b="<tr><td>"+e+'<span class="mathquill-embedded-latex">\\Vdash </span></td>';h="derivmotivation"}}if(this.mottype=="step"||this.mottype=="observation"){j.push("subderivation");k='<a href="javascript:;" class="sdaddbutton"><span>+</span></a>';j='<span class="plusbuttons" menuitems="'+j.join(" ")+'"></span>';k='<div class="sdafterbuttons">'+j+k+"</div>"}c.push(h);var o=this.text;var a="";var f=false;if(l=="show"){o=o.replace(/\$([^\$]+)\$/g,'<span class="mathquill-embedded-latex">$1</span>')}else{if(l=="edit"){o='<span class="mathquill-textbox">'+o+"</span>"}}o=b+'<td class="'+c.join(" ")+'" loc="'+g+'"><span class="motivationstring">'+o+"</span>"+k+"</td>";for(var d=0;d<this.subderivation.length;d++){f=f||this.subderivation[d].hidden}if(f){a="sdhidden"}for(var d=0;d<this.subderivation.length;d++){o+='</tr>\n<tr class="'+a+'"><td class="subder"></td><td class="subderivation" loc="'+g+"_subderivation_"+d+'">';o+=this.subderivation[d].htmlSub(l,g+"_subderivation_"+d);o+="\n</td>\n"}o+="</tr>\n";return o};_.lyx=function(e,c){if(c===undefined){c={}}var b="";if(this.mottype=="observation"){className="obsmotivation"}else{if(this.mottype=="derivation"){b="<tr><td>⊩</td>";className="derivmotivation"}}tdclasses.push(className);var a=this.text;a='<span class="mathquill-textbox">'+a+"</span>";a=b+'<td class="'+tdclasses.join(" ")+'" loc="'+e+'"><span class="motivationstring">'+a+"</span></td>";for(var d=0;d<this.subderivation.length;d++){a+='</tr>\n<tr class=""><td class="subder"></td><td class="subderivation" loc="'+e+"_subderivation_"+d+'">';a+=this.subderivation[d].lyxSub(e+"_subderivation_"+d);a+="\n</td>\n"}a+="</tr>\n";return a};_.getSaveData=function(){var b=[];for(var a=0;a<this.subderivation.length;a++){b.push(this.subderivation[a].name)}return{text:this.text,subderiv:b,virgin:this.virgin}};_.getSubSaveData=function(){var d=[];for(var c=0;c<this.subderivation.length;c++){var a=this.subderivation[c].getSaveData();for(var b=0;b<a.length;b++){d.push(a[b])}}return d};_.addSubderivation=function(b,e,c,d){if(typeof(b)!="string"||b==""){return}if(c===undefined){c=""}var a=new SdSubDeriv(b,c,d);this.subderivation.splice(e,0,a)};_.addSubderivationObject=function(a,b){this.subderivation.splice(b,0,a)};_.removeSubderivation=function(g,a){var d=this.subderivation[g];var f=[d.name];for(var c=0;c<d.observation.length;c++){for(var b=0;b<d.observation[c].motivation.subderivation.length;b++){var e=d.observation[c].motivation.removeSubderivation(b,a);f=f.concat(e)}}for(var c=0;c<d.motivation.length;c++){for(var b=0;b<d.motivation[c].subderivation.length;b++){var e=d.motivation[c].removeSubderivation(b,a);f=f.concat(e)}}this.subderivation.splice(g,1);return f};_.hideSubders=function(){for(var a=0;a<this.subderivation.length;a++){this.subderivation[a].hidden=true}};_.unhideSubders=function(){for(var a=0;a<this.subderivation.length;a++){this.subderivation[a].hidden=false}};_.switchHideSubders=function(){var a=false;for(var b=0;b<this.subderivation.length;b++){a=a||this.subderivation[b].hidden}if(a){this.unhideSubders()}else{this.hideSubders()}};function ButtonPanel(c){if(c===undefined){c=defbuttons}this.buttontables=[];if(c!=[]){for(var b=0;b<c.length;b++){table=new ButtonTable(c[b].name,c[b].icon);for(var a=0;a<c[b].elements.length;a++){element=new ButtonElement(c[b].elements[a].name,c[b].elements[a].latex,c[b].elements[a].icon,c[b].elements[a].inside,c[b].elements[a].move);table.addElement(element)}this.buttontables.push(table)}}this.lastfocus=""}_=ButtonPanel.prototype;_.createpanel=function(c){this.buttontables=[];if(c!=[]){for(var b=0;b<c.length;b++){table=new ButtonTable(c[b].name,c[b].icon);for(var a=0;a<c[b].elements.length;a++){element=new ButtonElement(c[b].elements[a].name,c[b].elements[a].latex,c[b].elements[a].icon);table.addElement(element)}this.buttontables.push(table)}}};_.addTable=function(a){this.buttontables.push(a)};_.html=function(){var a="";a+='<div id="mathbuttonpanel">\n';if(this.buttontables!=[]){a+='    <ul class="buttontablelist">\n';for(var b=0;b<this.buttontables.length;b++){a+='        <li class="buttontableicon">\n           <a href="javascript:;" class="'+this.buttontables[b].name+'"><span class="buttonicon">'+this.buttontables[b].icon+'</span><span class="buttoncategoryname">'+QedEditor.locales[this.buttontables[b].name][QedEditor.options.lang]+'</span></a>\n<div class="buttoncatwrapper">\n';a+=this.buttontables[b].html();a+="        </div></li>\n"}a+="    </ul>\n"}a+="</div>\n";return a};_.initClicks=function(){jQuery("#mathbuttonpanel .buttonelementtable a.buttonlink").click(function(){var f=jQuery(this).attr("title");var b=jQuery(this).attr("inside");var a=jQuery(QedEditor.buttonpanel.lastfocus);if(a.focus().find(".cursor").parent().hasClass("text")||a.focus().find(".cursor").parent().hasClass("mathquill-textbox")){return false}var e=a.data("[[mathquill internal data]]");var h=e&&e.block;var g=h&&h.cursor;var d="";if(g&&g.selection){var d=g.selection.latex()}if(d!=""){if(b=="1"){a.mathquill("write",f+"{"+g.selection.latex()+"}")}else{if(b=="2"){a.mathquill("write",f+"{"+g.selection.latex()+"}{}")}else{a.mathquill("write",f)}}}else{a.mathquill("write",f)}a.focus();if(g){for(var c=0;c<parseInt(b);c++){g.moveLeft()}}return false})};function ButtonTable(a,b){this.name=a;this.icon=b;this.buttonelements=[]}_=ButtonTable.prototype;_.html=function(){var b=this.buttonelements.length;var a="";if(b==0){return""}else{var c=Math.ceil(Math.sqrt(b));a+='                 <table class="buttonelementtable">\n';for(var e=0;c*e<b;e++){a+="                 <tr>\n";for(var d=0;d<c;d++){if(c*e+d<b){a+='                 <td>                     <a class="buttonlink '+this.buttonelements[c*e+d].name+'" href="javascript:;" title="'+this.buttonelements[c*e+d].latex+'" inside="'+this.buttonelements[c*e+d].has_inside+'" ><span>'+this.buttonelements[c*e+d].icon+"</span></a></td>\n"}else{a+="<td></td>"}}a+="                 </tr>\n"}a+="                 </table>\n"}return a};_.addElement=function(a){this.buttonelements.push(a)};function ButtonElement(b,d,c,a){this.name=b;this.latex=d;this.icon=c;if(a===undefined){a=0}this.has_inside=a}var defbuttons=[{name:"relations",icon:"R",elements:[{name:"equal",latex:"= ",icon:"="},{name:"lessthan",latex:"\\lt ",icon:"&lt;"},{name:"greaterthan",latex:"\\gt ",icon:"&gt;"},{name:"lessorequalthan",latex:"\\leq ",icon:"&le;"},{name:"greaterorequalthan",latex:"\\geq ",icon:"&ge;"},{name:"notequal",latex:"\\neq ",icon:"&ne;"},{name:"leftimp",latex:"\\Leftarrow ",icon:"&lArr;"},{name:"rightimp",latex:"\\Rightarrow ",icon:"&rArr;"},{name:"eqvivalent",latex:"\\iff ",icon:"&hArr;"}]},{name:"misc",icon:"M",elements:[{name:"frac",latex:"\\frac ",icon:"/",inside:"2"},{name:"sqroot",latex:"\\sqrt ",icon:"&radic;",inside:"1"},{name:"sub",latex:"_",icon:'X<sub style="color: red; font-weight: bold;">2</sub>',inside:"1"},{name:"sup",latex:"^",icon:'X<sup style="color: red; font-weight: bold;">2</sup>',inside:"1"},{name:"isin",latex:"\\in ",icon:"&isin;"},{name:"logicalor",latex:"\\lor ",icon:"&or;"},{name:"logicaland",latex:"\\and ",icon:"&and;"},{name:"logicalnot",latex:"\\not ",icon:"&not;"},{name:"infinity",latex:"\\inf ",icon:"&infin;"},{name:"empty",latex:"\\emptyset ",icon:"&empty;"},{name:"angle",latex:"\\angle ",icon:"&ang;"},{name:"degree",latex:"^{\\circ } ",icon:"&deg;"},{name:"approx",latex:"\\approx ",icon:"&asymp;"},{name:"plusminus",latex:"\\pm ",icon:"&plusmn;"}]},{name:"greeks",icon:"&alpha;",elements:[{name:"alpha",latex:"\\alpha ",icon:"&alpha;"},{name:"beta",latex:"\\beta ",icon:"&beta;"},{name:"gamma",latex:"\\gamma ",icon:"&gamma;"},{name:"delta",latex:"\\delta ",icon:"&delta;"},{name:"epsilon",latex:"\\epsilon ",icon:"&epsilon;"},{name:"zeta",latex:"\\zeta ",icon:"&zeta;"},{name:"eta",latex:"\\eta ",icon:"&eta;"},{name:"theta",latex:"\\theta ",icon:"&theta;"},{name:"iota",latex:"\\iota ",icon:"&iota;"},{name:"kappa",latex:"\\kappa ",icon:"&kappa;"},{name:"lambda",latex:"\\lambda ",icon:"&lambda;"},{name:"mu",latex:"\\mu ",icon:"&mu;"},{name:"nu",latex:"\\nu ",icon:"&nu;"},{name:"xi",latex:"\\xi ",icon:"&xi;"},{name:"pi",latex:"\\pi ",icon:"&pi;"},{name:"rho",latex:"\\rho ",icon:"&rho;"},{name:"sigma",latex:"\\sigma ",icon:"&sigma;"},{name:"tau",latex:"\\tau ",icon:"&tau;"},{name:"upsilon",latex:"\\upsilon ",icon:"&upsilon;"},{name:"phi",latex:"\\phi ",icon:"&phi;"},{name:"chi",latex:"\\chi ",icon:"&chi;"},{name:"psi",latex:"\\psi ",icon:"&psi;"},{name:"omega",latex:"\\omega ",icon:"&omega;"}]}];QedEditor.buttonpanel=new ButtonPanel();function EditorEvent(b,a,d,e,c){if(typeof(b)=="string"){this.event=b;if(typeof(a)=="undefined"){this.item=""}else{this.item=a}if(typeof(d)=="undefined"){this.location=""}else{this.location=d}if(typeof(e)=="undefined"){this.position=-1}else{this.position=parseInt(e)}if(typeof(c)=="undefined"){this.data=["",""]}else{this.data=c}}else{this.event=b.event;this.item=b.item;this.location=b.location;this.position=b.position;this.data=[b.data[0],b.data[1]]}}_=EditorEvent.prototype;_.oldData=function(){return this.data[1]};_.newData=function(){return this.data[0]};_.invertThis=function(){switch(this.event){case"edit":this.data.reverse();break;case"add":this.event="remove";this.data.reverse();break;case"remove":this.event="add";this.data.reverse();break;default:return this}};_.invert=function(){var a=new EditorEvent(this);a.invertThis();return a};function Eventstack(b,a){if(typeof(a)=="object"&&a.length){this.stackevents=a}else{this.stackevents=[]}this.maxstacksize=b}_=Eventstack.prototype;_.maxsize=function(a){if(typeof(a)=="number"){this.maxstacksize=a}else{return this.maxstacksize}};_.push=function(a){this.stackevents.push(a);if(this.stackevents.length>this.maxstacksize&&this.maxstacksize>0){this.stackevents.shift()}};_.pop=function(){return this.stackevents.pop()};_.clear=function(){this.stackevents=[]};_.size=function(){return this.stackevents.length};_.isempty=function(){return this.stackevents.length==0};function QedPlugin(a,d,c,b){this.editor=b||false;this.name=a;this.iconurl=d;this.buttons=[];this.data={};this.init=c||function(){return false}}_=QedPlugin.prototype;_.html=function(){var b='<div class="pluginbuttons" name="'+this.name+'">\n<span class="pluginname"><img src="'+this.iconurl+'" alt="'+this.name+'" style="height: 24px; width: auto;" /></span><ul>\n';for(var a=0;a<this.buttons.length;a++){b+=this.buttons[a].html()}b+="</ul>\n</div>\n";return b};_.setData=function(a){this.data=a};_.use=function(b){if(typeof(b)=="undefined"){b=this.editor}var d=new QedPlugin(this.name,this.iconurl,this.init,b);var c;for(var a=0;a<this.buttons.length;a++){d.buttons.push(this.buttons[a].use(this))}return d};_.addButton=function(a){a.plugin=this;this.buttons.push(a)};_.savedata=function(b,a){if(typeof(b)!="string"){return false}switch(this.editor.context){case"tiddlywiki":var c=QedEditor.options.TiddlyWiki.saveTiddler;if(typeof(this.editor.extraparams.tiddler)!="undefined"){c=this.editor.extraparams.tiddler}this.saveTiddly(c,b,a);break;case"moodlesa":this.saveMoodleSA(b,a);break;case"moodledesc":break;default:return"Invalid context!"}};_.saveTiddly=function(c,b,a){var e=this.editor.derivation.name;var d=DataTiddler.getData(c,"derivations",{});if(typeof(d[e].plugindata)=="undefined"){d[e].plugindata={}}if(typeof(d[e].plugindata[this.name])=="undefined"){d[e].plugindata[this.name]={}}if(typeof(a)!="undefined"){d[e].plugindata[this.name][b]=a}else{delete d[e].plugindata[this.name][b]}DataTiddler.setData(c,"derivations",d)};_.saveMoodleSA=function(h,f){var a=this.editor.derivation.name;var c=a.replace(/sub[0-9]+$/,"");var b=jQuery("#"+c+' .ablock input[type="text"]');var e=b.val();var k="{}";try{k=JSON.parse(e)}catch(g){k={derivations:{},recycled:{}}}if(typeof(k.derivations)=="undefined"){k.derivations={}}if(typeof(k.derivations[a].plugindata)=="undefined"){k.derivations[a].plugindata={}}if(typeof(k.derivations[a].plugindata[this.name])=="undefined"){k.derivations[a].plugindata[this.name]={}}if(typeof(f)!="undefined"){k.derivations[a].plugindata[this.name][h]=f}else{delete k.derivations[a].plugindata[this.name][h]}e=JSON.stringify(k);b.val(e);if(this.saveajax){var d=$("form#responseform").attr("action")+"#"+c;var j=jQuery('<div class="ajaxanswer"></div>');var i={};i["resp"+c.slice(1)+"_"]=e;i["resp"+c.slice(1)+"_submit"]="Submit";i.timeup=0;i.questionids=c.slice(1);testilogit.ajaxresponse=jQuery.post(d,i)}};_.getdata=function(a){if(typeof(a)!="string"){return false}switch(this.editor.context){case"tiddlywiki":var b=QedEditor.options.TiddlyWiki.saveTiddler;if(typeof(this.editor.extraparams.tiddler)!="undefined"){b=this.editor.extraparams.tiddler}return this.getdataTiddly(b,a);break;case"moodlesa":return this.getdataMoodleSA(a);break;case"moodledesc":break;default:return"Invalid context!"}};_.getdataTiddly=function(e,c){var g=this.editor.derivation.name;var f,a;var b={};b[g]={task:[],assumption:[],observation:[],derivmotivation:[],term:[{text:"",virgin:false}],relation:[],motivation:[],check:""};var d=DataTiddler.getData(e,"derivations",b);if(typeof(d[g])=="undefined"){f=b[g]}else{f=d[g]}if(typeof(f.plugindata)=="undefined"){a={}}else{a=f.plugindata}if(typeof(a[this.name])=="undefined"){a={}}else{a=a[this.name]}return a[c]};_.getdataMoodleSA=function(h){var a=this.editor.derivation.name;var d,g;var c=this.editor.name;var b=jQuery("#"+c+' .ablock input[type="text"]');var e=b.val();var i="{}";try{i=JSON.parse(e)}catch(f){i={derivations:{},recycled:{}}}if(typeof(i.derivations)=="undefined"){i.derivations={}}var d=(typeof(i.derivations[a])!="undefined")?i.derivations[a]:{task:[],assumption:[],observation:[],derivmotivation:[],term:[{text:"",virgin:false}],relation:[],motivation:[],check:""};if(typeof(d.plugindata)=="undefined"){g={}}else{g=d.plugindata}if(typeof(g[this.name])=="undefined"){g={}}else{g=g[this.name]}return g[h]};function QedPluginButton(a,d,c,b){this.plugin=b||false;this.name=a;this.iconurl=d;this.action=c||function(){alert(this.name)}}_=QedPluginButton.prototype;_.html=function(){var a='<li class="pluginitem"><a href="javascript:" class="pluginbutton"><span><img src="'+this.iconurl+'" alt="'+this.name+'" style="height: 24px; width: auto;" />'+this.name+"</span></a></li>\n";return a};_.use=function(b){if(typeof(b)=="undefined"){b=this.plugin}var a=new QedPluginButton(this.name,this.iconurl,this.action,b);return a};QedEditor.plugins=[];QedEditor.plugindata={};QedEditor.addPlugin=function(c){var a=-1;for(var b=0;b<QedEditor.plugindata.plugins.length;b++){if(QedEditor.plugindata.plugins[b].name==c.name){a=b;break}}if(a!=-1&&typeof(c)!="undefined"){QedEditor.plugins[a]=c}};